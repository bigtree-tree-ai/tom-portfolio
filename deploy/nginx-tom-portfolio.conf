# ================================
# Nginx 配置文件：tom-portfolio
# ================================
# 文件位置：/etc/nginx/sites-available/tom-portfolio
#
# 设计思路：
# 1. 静态文件服务：前端页面 (端口 8081)
# 2. API 反向代理：后端服务 (localhost:5002)
# 3. 安全头设置：防止常见 Web 漏洞
# 4. 日志隔离：项目独立的日志文件
# ================================

server {
    listen 8081;
    server_name _;

    # ================================
    # 安全头设置
    # ================================
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ================================
    # 日志配置（项目隔离）
    # ================================
    access_log /data/tom-portfolio/logs/nginx-access.log;
    error_log /data/tom-portfolio/logs/nginx-error.log;

    # ================================
    # 静态文件服务
    # ================================
    location / {
        root /data/tom-portfolio/app;
        index index.html;
        try_files $uri $uri/ /index.html =404;
    }

    # ================================
    # API 反向代理（后端服务）
    # ================================
    location /api/ {
        proxy_pass http://localhost:5002;

        # 代理头设置
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ================================
    # 健康检查端点
    # ================================
    location /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ================================
    # 禁止访问隐藏文件
    # ================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
